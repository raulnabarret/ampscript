<style type="text/css">
	.content-wrapper {
	    height: 100%;
	    width: 50%;
	    background: #9bcace;
	    padding: 1em;
	}
</style>

<div class="content-wrapper">
%%[	
	//12608
	SET @Random = RANDOM(100, 999)
	SET @EmailAddress = 'raulnabarret@gmail.com'


	SET @rrObj = CreateObject("RetrieveRequest") 

	SetObjectProperty(@rrObj, "ObjectType", "Subscriber")
	AddObjectArrayItem(@rrObj,"Properties","SubscriberKey")

	SET @cObj = CreateObject("SimpleFilterPart")
	SetObjectProperty(@cObj, "Property", "SubscriberKey")
	SetObjectProperty(@cObj, "SimpleOperator", "equals")
	AddObjectArrayItem(@cObj, "Value",@EmailAddress)

	SetObjectProperty(@rrObj, "Filter", @cObj)

	SET @ResultSet = InvokeRetrieve(@rrObj)

	IF(Rowcount(@ResultSet)>0) THEN       
	    SET @row = row(@ResultSet,1)        
	    SET @Status = Field(@row,"Status")
	ENDIF

]%%
Random: %%=v(@Random)=%%
	<div>
		<h1>Email Preference Center</h1>
		%%=v(@Status)=%%
	</div>
	<div>
		<div>
			<h2>Update Your Email Address</h2>	
		</div>
		<div>
			<label>Email Address</label>
			<input type="email" name="email" value="%%=v(@EmailAddress)=%%">
		</div>
		<div>
			<button>Update</button>
		</div>
	</div>
	<div>
		<div>
			<h2>Newsletters</h2>	
		</div>
		<div>
			<form onsubmit="return handleSubmitPreferences(this)">
				<div>
					<input type="checkbox" name="quarterlyNewsletters" id="quarterlyNewsletters">
					<label for="quarterlyNewsletters">Quarterly Newsletters</label>
				</div>
				<div>
					<button type="submit">Save Preferences</button>
				</div>
			</form>
		</div>
	</div>	
</div>
<script type="text/javascript">
	function handleSubmitPreferences() {
		var quarterlyNewsletters = document.querySelector('#quarterlyNewsletters').checked;
		console.log(quarterlyNewsletters);
		%%[
 			SET @quarterlyNewsletters = RequestParameter('quarterlyNewsletters')
		    SET @ListID = "12608"
		    SET @SubscriberKey = @EmailAddress
		 
		    SET @rr = CreateObject("RetrieveRequest")
		    SetObjectProperty(@rr,"ObjectType","ListSubscriber")
		    AddObjectArrayItem(@rr,"Properties","SubscriberKey")
		    AddObjectArrayItem(@rr,"Properties","ListID")
		    
		    SET @sfpl = CreateObject("SimpleFilterPart")
		    SetObjectProperty(@sfpl,"Property","ListID")
		    SetObjectProperty(@sfpl,"SimpleOperator","equals")
		    AddObjectArrayItem(@sfpl,"Value",@ListID)
		 
		    SET @sfpr = CreateObject("SimpleFilterPart")
		    SetObjectProperty(@sfpr,"Property","SubscriberKey")
		    SetObjectProperty(@sfpr,"SimpleOperator","equals")
		    AddObjectArrayItem(@sfpr,"Value",@SubscriberKey)
		 
		    SET @cf = CreateObject("ComplexFilterPart")
		    SetObjectProperty(@cf,"LeftOperand",@sfpl)
		    SetObjectProperty(@cf,"RightOperand",@sfpr)
		    SetObjectProperty(@cf,"LogicalOperator","AND")
		 
		    SetObjectProperty(@rr,"Filter",@cf)
		    
		    SET @listFields = InvokeRetrieve(@rr)
		 
		    /* Update only when it is not already present */
		    IF NOT(RowCount(@listFields)) THEN
		        SET @sub = CreateObject("Subscriber")
		        SetObjectProperty(@sub,"SubscriberKey",@SubscriberKey)

		        set @lSub = CreateObject("SubscriberList")
		        SetObjectProperty(@lSub,"ID",@ListID)
		        SetObjectProperty(@lSub,"Status","Unsubscribed")
		        AddObjectArrayItem(@sub,"Lists",@lSub)

		        SET @updateStatus = InvokeUpdate(@sub)

		        IF @updateStatus == "OK" THEN
		          Output(v("Subscriber added to the list successfully!"))
		        ELSE
		          Output(v("There was a problem adding the subscriber added to the list!"))
		        ENDIF
		    ELSE
		        Output(v("Subscriber already exists in list"))
		    ENDIF
		]%%
	}
</script>

